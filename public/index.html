<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Xikipedia</title>
    <meta property="og:url" content="https://xikipedia.emilycogsdill.com/">
    <meta property="og:title" content="Xikipedia">
    <meta name="description" content="Wikipedia you can doomscroll">
    <meta property="og:description" content="Wikipedia you can doomscroll">
    <meta property="og:locale" content="en-us">
    <meta property="og:type" content="website">
    <meta content="#38444D" name="theme-color">
    <link rel="icon" href="/favicon.ico">
    <style>
        :root {
            --bg-primary: #15202B;
            --bg-secondary: #1C2732;
            --bg-tertiary: #000;
            --text-primary: #FFF;
            --text-secondary: #8899aa;
            --border-color: #38444D;
            --accent-color: #2cafff;
        }

        :root.light-mode {
            --bg-primary: #FFFFFF;
            --bg-secondary: #F7F9FA;
            --bg-tertiary: #EFF3F4;
            --text-primary: #0F1419;
            --text-secondary: #536471;
            --border-color: #EFF3F4;
            --accent-color: #1D9BF0;
        }

        html, body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: system-ui, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
            justify-content: center;
        }
        .posts {
            max-width: 600px;
            width: 100vw;
            border: 1px solid var(--border-color);
            border-top: none;
            height: fit-content;
        }
        .posts:has(.post) {
            margin-bottom: 1000px;
        }
        .stats {
            max-width: 300px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            position: fixed;
            right: -320px;
            top: 0;
            height: 100%;
            width: 300px;
            padding: 16px;
            padding-top: 48px;
            font-family: monospace;
            font-size: 12px;
            background: var(--bg-primary);
            z-index: 200;
            transition: right 0.3s ease;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .stats.open {
            right: 0;
        }
        .post {
            padding: 12px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;
        }
        .post:hover,
        .post:focus {
            background: var(--bg-secondary);
        }
        .post:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: -2px;
        }
        .post h1 {
            font-size: 100%;
            margin: 0;
        }
        .post p {
            margin: 0;
            word-break: break-word;
        }
        .post button:not(.feedback-btn) {
            align-self: end;
            margin: -4px;
            margin-top: 4px;
            padding: 4px;
            background: transparent;
            transition: background 0.2s, transform 0.2s cubic-bezier(.15,.67,0,1);
            border-radius: 64px;
            font-size: 0;
            border: 0;
            cursor: pointer;
        }
        .post button:not(.feedback-btn):hover:not([data-liked]) {
            background: rgba(255,255,255,0.13);
            transform: scale(1.1);
        }
        .post button:not(.feedback-btn):active:not([data-liked]),
        .post button:not(.feedback-btn):active {
            transform: scale(0.9);
        }
        .post button:not(.feedback-btn)::after {
            font-size: 16px;
            display: block;
            width: 24px;
            height: 24px;
            margin-top: 1px;
            margin-bottom: -1px;
            content: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.06,21.01c3.94,0,13.77-11.36,8.56-16.37-4.59-4.41-8.61,1.58-8.61,1.58,0,0-4.02-5.99-8.61-1.58-5.22,5.01,4.61,16.37,8.56,16.37h.11Z" stroke-width="2" fill="none" stroke="%2389A" stroke-linejoin="round"/></svg>');
        }
        .post button:not(.feedback-btn)[data-liked]::after {
            content: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.06,21.01c3.94,0,13.77-11.36,8.56-16.37-4.59-4.41-8.61,1.58-8.61,1.58,0,0-4.02-5.99-8.61-1.58-5.22,5.01,4.61,16.37,8.56,16.37h.11Z" stroke-width="2" fill="red" stroke="red"/></svg>');
        }
        .post button.share-btn::after {
            content: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16c-.8 0-1.5.3-2 .8l-7-4c.1-.3.1-.5.1-.8s0-.5-.1-.8l7-4c.5.5 1.2.8 2 .8 1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3c0 .3 0 .5.1.8l-7 4c-.5-.5-1.2-.8-2-.8-1.7 0-3 1.3-3 3s1.3 3 3 3c.8 0 1.5-.3 2-.8l7 4c-.1.3-.1.5-.1.8 0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3z" fill="%2389A"/></svg>');
        }
        .post button.share-btn.copied::after {
            content: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16c-.8 0-1.5.3-2 .8l-7-4c.1-.3.1-.5.1-.8s0-.5-.1-.8l7-4c.5.5 1.2.8 2 .8 1.7 0 3-1.3 3-3s-1.3-3-3-3-3 1.3-3 3c0 .3 0 .5.1.8l-7 4c-.5-.5-1.2-.8-2-.8-1.7 0-3 1.3-3 3s1.3 3 3 3c.8 0 1.5-.3 2-.8l7 4c-.1.3-.1.5-.1.8 0 1.7 1.3 3 3 3s3-1.3 3-3-1.3-3-3-3z" fill="%232cafff"/></svg>');
        }
        .post .button-row {
            align-self: stretch;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        /* Double-tap like animation */
        @keyframes doubleTapLike {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .double-tap-heart {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 80px;
            height: 80px;
            pointer-events: none;
            animation: doubleTapLike 0.6s ease-out forwards;
            z-index: 10;
        }
        .post {
            position: relative;
        }
        .post img.media {
            border-radius: 16px;
            border: 1px solid var(--border-color);
            display: block;
            margin: 8px 0;
            max-width: min(512px, 100%);
            max-height: 330px;
            background: #FFF;
        }
        .fullImg {
            max-height: 95%;
            max-width: 95%;
            min-width: 25%;
            min-height: 25%;
        }
        body ::backdrop {
            background: rgba(0,0,0,0.6);
        }
        #startScreen {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            border: none;
            width: 90%;
            height: 90%;
            max-width: 600px;
            color: var(--text-primary);
            border-radius: 8px;
            padding: 32px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        #startScreen h1,
        #startScreen h2 {
            margin: 0;
        }
        #categoryPickList {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 8px 0;
        }
        .categoryPicker {
            border-radius: 100px;
            cursor: pointer;
            padding: 10px;
            display: inline-flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: inset 0px 0px 1.2px 0px #000;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .categoryPicker::after {
            content: "+";
            color: var(--accent-color);
            font-size: 150%;
            line-height: 0;
            margin-left: 8px;
        }
        .categoryPicker:hover,
        .categoryPicker:active {
            background: var(--border-color);
        }
        .categoryPicker:has(input:checked) {
            background: var(--text-primary);
            color: var(--bg-primary);
        }
        .categoryPicker:has(input:checked)::after {
            content: "‚àí";
            color: var(--bg-primary);
        }
        .categoryPicker:has(input:focus-visible) {
            outline: 2px solid var(--accent-color);
        }
        .categoryPicker input {
            opacity: 0;
            position: absolute;
            pointer-events: none;
        }
        #startBtn {
            border-radius: 32px;
            padding: 12px;
            background: var(--accent-color);
            color: #FFF;
            border: 1px solid var(--bg-tertiary);
            font: inherit;
            cursor: pointer;
        }
        #startBtn[disabled] {
            background: #557;
            cursor: not-allowed;
        }
        #categorySearch {
            margin: 8px 0;
            gap: 8px;
        }
        #categorySearch input {
            border-radius: 32px;
            padding: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--bg-tertiary);
            font: inherit;
        }
        #categorySearch input[disabled] {
            background: #557;
            cursor: not-allowed;
        }
        #categorySearch select:not(:has(option)) {
            display: none;
        }
        a[href] {
            color: var(--accent-color);
        }
        #loading {
            text-align: center;
            padding: 20px;
        }
        .loading-details {
            font-size: 14px;
            opacity: 0.85;
            margin-top: 8px;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .loading-progress {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            margin: 12px 0;
            overflow: hidden;
        }
        .loading-progress-bar {
            height: 100%;
            background: var(--accent-color);
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .error-message {
            background: #5c2626;
            border: 1px solid #8b3a3a;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            display: none;
        }
        .error-message.visible {
            display: block;
        }
        .retry-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
        }
        .retry-btn:hover {
            background: #1a9ae8;
        }
        .recommendation-reason {
            font-size: 12px;
            color: var(--accent-color);
            margin: 4px 0 8px 0;
            font-style: italic;
            opacity: 0.9;
        }
        #themeToggle {
            position: fixed;
            top: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
        }
        .session-stats {
            position: fixed;
            bottom: 80px;
            left: 16px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 100;
        }
        @media (max-width: 600px) {
            .session-stats { display: none; }
        }
        .data-freshness {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 4px 0;
        }
        .surprise-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font: inherit;
            cursor: pointer;
            margin: 8px 0;
        }
        .surprise-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        /* === Feature 2: Refresh button & pull-to-refresh === */
        .floating-btn {
            position: fixed;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #2cafff;
            border: none;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s, opacity 0.2s;
        }
        .floating-btn:hover {
            transform: scale(1.1);
        }
        .floating-btn:active {
            transform: scale(0.9);
        }
        #refreshBtn {
            right: 24px;
            bottom: 24px;
        }
        #refreshBtn::after {
            content: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M17.65 6.35A7.96 7.96 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" fill="white"/></svg>');
        }
        .pull-to-refresh-indicator {
            text-align: center;
            padding: 12px;
            color: #8899AA;
            font-size: 14px;
            transition: opacity 0.3s;
            overflow: hidden;
            height: 0;
        }
        .pull-to-refresh-indicator.active {
            height: auto;
        }
        .pull-to-refresh-indicator .spinner {
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* === Feature 1: More/Less feedback buttons === */
        /* Icons are now added via CSS ::before with emoji */
        .post .feedback-btn {
            position: relative;
            font-size: 13px;
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .post .feedback-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }
        .post .feedback-btn:disabled {
            opacity: 0.5;
            cursor: default;
        }
        .post .more-btn::before {
            content: 'üëç ';
        }
        .post .less-btn::before {
            content: 'üëé ';
        }
        .post .feedback-btn .got-it {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: var(--accent-color, #2cafff);
            white-space: nowrap;
            pointer-events: none;
            animation: gotItFade 1s ease-out forwards;
        }
        @keyframes gotItFade {
            0% { opacity: 1; transform: translateX(-50%) translateY(0); }
            70% { opacity: 1; transform: translateX(-50%) translateY(-4px); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-8px); }
        }
        .post .button-spacer {
            flex: 1;
        }

        /* === Feature 3: Sidebar category controls === */
        .stats-section-title {
            font-weight: bold;
            color: var(--text-secondary, #8899AA);
            margin: 8px 0 4px 0;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .cat-row {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .cat-row .cat-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }
        .cat-row .cat-score {
            color: var(--text-secondary, #8899AA);
            min-width: 40px;
            text-align: right;
            margin-right: 4px;
        }
        .cat-row .cat-ctrl {
            width: 20px;
            height: 20px;
            border: 1px solid var(--border-color, #38444D);
            border-radius: 4px;
            background: transparent;
            color: var(--text-secondary, #8899AA);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            flex-shrink: 0;
        }
        .cat-row .cat-ctrl:hover {
            background: var(--bg-secondary, #1C2732);
            color: var(--text-primary, #FFF);
            border-color: var(--accent-color, #2cafff);
        }
        .hidden-section {
            margin-top: 8px;
            border-top: 1px solid var(--border-color, #38444D);
            padding-top: 4px;
        }
        .hidden-toggle {
            cursor: pointer;
            color: var(--text-secondary, #8899AA);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: none;
            border: none;
            padding: 4px 0;
            font-family: monospace;
            width: 100%;
            text-align: left;
        }
        .hidden-toggle:hover {
            color: var(--text-primary, #FFF);
        }
        .hidden-list {
            display: none;
        }
        .hidden-list.expanded {
            display: block;
        }
        .hidden-row {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .hidden-row .cat-name {
            flex: 1;
            color: var(--text-secondary, #8899AA);
            text-decoration: line-through;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }
        .unhide-btn {
            font-size: 10px;
            color: var(--accent-color, #2cafff);
            background: none;
            border: 1px solid var(--border-color, #38444D);
            border-radius: 4px;
            cursor: pointer;
            padding: 2px 6px;
            font-family: monospace;
            flex-shrink: 0;
        }
        .unhide-btn:hover {
            background: var(--bg-secondary, #1C2732);
            border-color: var(--accent-color, #2cafff);
        }

        /* === Feature 4: Mobile sidebar drawer === */
        #statsToggleBtn {
            position: fixed;
            left: 24px;
            bottom: 24px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent-color, #2cafff);
            border: none;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        #statsToggleBtn:hover {
            transform: scale(1.1);
        }
        #statsToggleBtn:active {
            transform: scale(0.9);
        }
        #statsToggleBtn::after {
            content: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M5 9.2h3V19H5V9.2zM10.6 5h2.8v14h-2.8V5zm5.6 8H19v6h-2.8v-6z" fill="white"/></svg>');
        }
        @media (max-width: 600px) {
            .stats {
                max-width: 80vw;
            }
        }
        .stats-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 199;
        }
        .stats-backdrop.visible {
            display: block;
        }
        .stats-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-secondary, #8899AA);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            display: block;
            z-index: 201;
        }
        .stats-close:hover {
            color: var(--text-primary, #FFF);
        }

        /* === Auth UI === */
        #authSection {
            margin: 12px 0;
            border: 1px solid #38444D;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #38444D;
        }
        .auth-tab {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            color: #8899AA;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font: inherit;
            font-size: 14px;
            transition: color 0.2s, border-color 0.2s;
        }
        .auth-tab:hover {
            color: #FFF;
        }
        .auth-tab.active {
            color: #2cafff;
            border-bottom-color: #2cafff;
        }
        .auth-tab-content {
            display: none;
            padding: 12px;
        }
        .auth-tab-content.active {
            display: block;
        }
        .auth-tab-content input[type="text"],
        .auth-tab-content input[type="password"] {
            width: 100%;
            box-sizing: border-box;
            border-radius: 32px;
            padding: 10px 14px;
            background: #000;
            color: #FFF;
            border: 1px solid #38444D;
            font: inherit;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .auth-tab-content input[type="text"]:focus,
        .auth-tab-content input[type="password"]:focus {
            outline: none;
            border-color: #2cafff;
        }
        .auth-submit-btn {
            width: 100%;
            border-radius: 32px;
            padding: 10px;
            background: #2cafff;
            color: #FFF;
            border: none;
            font: inherit;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .auth-submit-btn:hover {
            opacity: 0.9;
        }
        .auth-submit-btn:disabled {
            background: #557;
            cursor: not-allowed;
        }
        .auth-error {
            color: #ff6b6b;
            font-size: 13px;
            margin-top: 4px;
            min-height: 0;
        }
        .auth-guest-msg {
            color: #8899AA;
            font-size: 13px;
            margin: 4px 0;
        }
        .auth-welcome {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            font-size: 14px;
        }
        .auth-welcome a {
            font-size: 13px;
            cursor: pointer;
        }
        #logoutBtn {
            position: fixed;
            top: 12px;
            right: 12px;
            background: transparent;
            border: 1px solid #38444D;
            color: #8899AA;
            padding: 6px 14px;
            border-radius: 20px;
            font: inherit;
            font-size: 12px;
            cursor: pointer;
            z-index: 100;
            display: none;
        }
        #logoutBtn:hover {
            color: #FFF;
            border-color: #2cafff;
        }
        #deleteAccountBtn {
            position: fixed;
            top: 12px;
            right: 100px;
            background: transparent;
            border: 1px solid #38444D;
            color: #664444;
            padding: 6px 14px;
            border-radius: 20px;
            font: inherit;
            font-size: 11px;
            cursor: pointer;
            z-index: 100;
            display: none;
        }
        #deleteAccountBtn:hover {
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
    </style>
</head>
<body>
    <button id="themeToggle" aria-label="Toggle dark/light mode">&#127769;</button>
    <p id="loading">Loading...</p>
    <div class="posts" data-testid="posts" role="feed" aria-label="Wikipedia article feed"></div>
    <div id="sessionStats" class="session-stats">
        <span id="viewCount">0</span> viewed ¬∑ <span id="likeCount">0</span> liked
    </div>
    <aside class="stats" data-testid="stats" aria-live="polite" aria-label="Category engagement scores">
        <button class="stats-close" aria-label="Close sidebar">&times;</button>
    </aside>
    <div class="stats-backdrop" id="statsBackdrop"></div>
    <button id="statsToggleBtn" aria-label="Open category stats"></button>
    <button class="floating-btn" id="refreshBtn" aria-label="Refresh feed" style="display:none"></button>
    <div id="startScreen" popover="manual">
        <div>
            <h1>Xikipedia</h1>
            <h2 style="font-size: 100%;opacity:0.85;font-style:italic">
                by <a href="https://lyra.horse">rebane2001</a>
            </h2>
        </div>
        <p>
            <strong>Xikipedia</strong> is a pseudo social media feed that algorithmically shows you content from 
            <a href="https://simple.wikipedia.org/">Simple Wikipedia</a>. It is made as a demonstration of how 
            even a basic non-ML algorithm with no data from other users can quickly learn what you engage with 
            to suggest you more similar content. No data is collected or shared here, the algorithm runs locally 
            and the data disappears once you refresh or close the tab.
        </p>
        <p>
            Original source on <a href="https://github.com/rebane2001/xikipedia">GitHub</a>.
            Recreation hosted on Cloudflare Workers.
        </p>
        <div id="authSection">
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="guest">Guest</button>
                <button class="auth-tab" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="register">Register</button>
            </div>
            <div class="auth-tab-content active" data-tab-content="guest">
                <p class="auth-guest-msg">Browse without an account. Your preferences won't be saved.</p>
            </div>
            <div class="auth-tab-content" data-tab-content="login">
                <input type="text" id="loginUsername" placeholder="Username" autocomplete="username">
                <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password">
                <button class="auth-submit-btn" id="loginBtn">Log in</button>
                <div class="auth-error" id="loginError"></div>
            </div>
            <div class="auth-tab-content" data-tab-content="register">
                <input type="text" id="registerUsername" placeholder="Username" autocomplete="username">
                <input type="password" id="registerPassword" placeholder="Password" autocomplete="new-password">
                <input type="password" id="registerConfirm" placeholder="Confirm password" autocomplete="new-password">
                <button class="auth-submit-btn" id="registerBtn">Create account</button>
                <div class="auth-error" id="registerError"></div>
            </div>
        </div>
        <div id="categoryPickerSection">
        <p style="font-weight: 600;margin:0">Pick some categories to get started (optional)</p>
        <div id="categoryPickList"></div>
        <button id="surpriseMe" class="surprise-btn">üé≤ Surprise me!</button>
        <p style="font-weight: 600;margin:0">Or add your own</p>
        <div id="categorySearch" style="display:flex;flex-direction:column">
            <input placeholder="Estonia..." disabled data-testid="category-search-input" aria-label="Search for categories">
            <select size="5" data-testid="category-search-select" aria-label="Category search results"></select>
        </div>
        </div>
        <p style="margin-top:auto">
            Since the content and images shown is from random Wikipedia articles, you will likely see
            NSFW content. Please only continue if you're an adult.
        </p>
        <p class="data-freshness">Data last updated: <span id="lastUpdated">February 2026</span></p>
        <div class="loading-progress" id="loadingProgress" style="display:none">
            <div class="loading-progress-bar" id="loadingProgressBar"></div>
        </div>
        <div class="loading-details" id="loadingDetails"></div>
        <div class="error-message" id="errorMessage">
            <strong>Failed to load data</strong>
            <p id="errorText">Network error occurred.</p>
            <button class="retry-btn" id="retryBtn">Try again</button>
        </div>
        <button id="startBtn" disabled data-testid="start-button" aria-label="Start browsing Xikipedia (adult content warning)">I'm an adult, continue</button>
    </div>
    <button id="logoutBtn">Log out</button>
    <button id="deleteAccountBtn">Delete account</button>
<script>
    // ============================================
    // Xikipedia - Wikipedia as a Social Media Feed
    // Original by rebane2001 (https://lyra.horse)
    // Recreation for Cloudflare Workers deployment
    // ============================================

    // Theme toggle functionality
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.onclick = () => {
        document.documentElement.classList.toggle('light-mode');
        themeToggle.textContent = document.documentElement.classList.contains('light-mode') ? '\u2600\uFE0F' : '\uD83C\uDF19';
        localStorage.setItem('theme', document.documentElement.classList.contains('light-mode') ? 'light' : 'dark');
    };
    // Load saved theme
    if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.add('light-mode');
        themeToggle.textContent = '\u2600\uFE0F';
    }

    const DATA_LAST_UPDATED = "February 2026";
    const pagesArr = [];
    let noPageMaps = {};
    const recursiveCache = new Map();

    // Session stats tracking
    let articlesViewed = 0;
    let articlesLiked = 0;
    let currentStreak = 0;
    let maxStreak = 0;

    const categoryScores = {
        "given names": -1000,
        "surnames": -1000,
    };
    const hiddenCategories = new Set();
    const defaultCategories = [
        "nature", "science", "animals", "anthropology", "places",
        "sociology", "art", "mathematics", "games", "technology",
        "music", "human sexuality"
    ];
    let postsWithoutLike = 0;
    const DATA_SIZE = 225690064;

    // ============================================
    // Auth state management
    // ============================================

    function isLoggedIn() {
        return !!localStorage.getItem('xiki_token');
    }

    function currentUser() {
        return localStorage.getItem('xiki_username') || null;
    }

    function getAuthHeaders() {
        const token = localStorage.getItem('xiki_token');
        if (token) return { 'Authorization': 'Bearer ' + token };
        return {};
    }

    function logout() {
        localStorage.removeItem('xiki_token');
        localStorage.removeItem('xiki_username');
        window.location.reload();
    }

    async function deleteAccount() {
        const password = prompt('Enter your password to confirm account deletion:');
        if (!password) return;
        if (!confirm('Are you sure? This cannot be undone.')) return;
        try {
            const resp = await fetch('/api/account', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    ...getAuthHeaders()
                },
                body: JSON.stringify({ password })
            });
            if (!resp.ok) {
                const data = await resp.json().catch(() => ({}));
                alert(data.error || 'Failed to delete account. Please try again.');
                return;
            }
        } catch (e) {
            console.error('Delete account failed:', e);
            alert('Failed to delete account. Please try again.');
            return;
        }
        localStorage.removeItem('xiki_token');
        localStorage.removeItem('xiki_username');
        window.location.reload();
    }

    // Debounced preference saving
    let saveTimeout = null;
    function savePreferences() {
        if (!isLoggedIn()) return;
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            const body = {
                categoryScores: categoryScores,
                hiddenCategories: Array.from(hiddenCategories)
            };
            fetch('/api/preferences', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    ...getAuthHeaders()
                },
                body: JSON.stringify(body)
            }).catch(e => console.error('Failed to save preferences:', e));
        }, 5000);
    }

    // Double-tap detection state
    let lastTapTime = 0;
    let lastTapTarget = null;
    let singleTapTimer = null;

    // DOM Elements
    const startBtn = document.getElementById("startBtn");
    const startScreen = document.getElementById("startScreen");
    const categoryPickList = document.getElementById("categoryPickList");
    const categorySearch = document.getElementById("categorySearch");
    const categorySearchInput = categorySearch.querySelector("input");
    const categorySearchSelect = categorySearch.querySelector("select");

    // Category search functionality
    categorySearchInput.oninput = () => {
        const searchText = categorySearchInput.value;
        if (!searchText.length) {
            categorySearchSelect.innerText = "";
            return;
        }
        const searchTarget = [
            ...pagesArr.map(e => e.title.toLowerCase()), 
            ...Object.values(noPageMaps).map(e => e.toLowerCase())
        ];
        let results = searchTarget
            .filter(e => e.startsWith(searchText.toLowerCase()))
            .slice(0, 100);
        if (results.length < 100) {
            results = [
                ...results, 
                ...searchTarget
                    .filter(e => e.includes(searchText.toLowerCase()) && !results.includes(e))
                    .slice(0, 100 - results.length)
            ];
        }
        if (results.length === 100) {
            results.push("...");
        }
        categorySearchSelect.innerText = "";
        results.forEach(e => {
            const option = document.createElement("option");
            option.innerText = `${e.slice(0, 1).toUpperCase()}${e.slice(1).toLowerCase()}`;
            option.value = e;
            categorySearchSelect.appendChild(option);
        });
    };

    categorySearchSelect.oninput = () => {
        if (!categorySearchSelect.value || categorySearchSelect.value === "...") return;
        addPickableCategory(categorySearchSelect.value, true);
    };

    // Surprise me button handler
    document.getElementById('surpriseMe').onclick = () => {
        // Uncheck all current selections
        document.querySelectorAll('.categoryPicker input:checked').forEach(cb => cb.checked = false);

        // Pick 3-5 random categories from defaultCategories
        const shuffled = [...defaultCategories].sort(() => Math.random() - 0.5);
        const count = 3 + Math.floor(Math.random() * 3); // 3-5 categories
        const selected = shuffled.slice(0, count);

        // Check those categories
        selected.forEach(cat => {
            const checkbox = document.querySelector(`.categoryPicker input[data-category="${cat}"]`);
            if (checkbox) checkbox.checked = true;
        });
    };

    // ============================================
    // Auth UI: Tab switching and form submission
    // ============================================

    document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.onclick = () => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.querySelector(`[data-tab-content="${tab.dataset.tab}"]`).classList.add('active');
        };
    });

    async function handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorEl = document.getElementById('loginError');
        const btn = document.getElementById('loginBtn');

        if (!username || !password) {
            errorEl.textContent = 'Please enter username and password.';
            return;
        }

        errorEl.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Logging in...';

        try {
            const resp = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await resp.json();
            if (!resp.ok) {
                errorEl.textContent = data.error || 'Login failed.';
                btn.disabled = false;
                btn.textContent = 'Log in';
                return;
            }
            localStorage.setItem('xiki_token', data.token);
            localStorage.setItem('xiki_username', data.username);
            window.location.reload();
        } catch (e) {
            errorEl.textContent = 'Network error. Please try again.';
            btn.disabled = false;
            btn.textContent = 'Log in';
        }
    }

    async function handleRegister() {
        const username = document.getElementById('registerUsername').value.trim();
        const password = document.getElementById('registerPassword').value;
        const confirmPw = document.getElementById('registerConfirm').value;
        const errorEl = document.getElementById('registerError');
        const btn = document.getElementById('registerBtn');

        if (!username || !password) {
            errorEl.textContent = 'Please enter username and password.';
            return;
        }
        if (password !== confirmPw) {
            errorEl.textContent = 'Passwords do not match.';
            return;
        }

        errorEl.textContent = '';
        btn.disabled = true;
        btn.textContent = 'Creating account...';

        try {
            const resp = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await resp.json();
            if (!resp.ok) {
                errorEl.textContent = data.error || 'Registration failed.';
                btn.disabled = false;
                btn.textContent = 'Create account';
                return;
            }
            localStorage.setItem('xiki_token', data.token);
            localStorage.setItem('xiki_username', data.username);
            window.location.reload();
        } catch (e) {
            errorEl.textContent = 'Network error. Please try again.';
            btn.disabled = false;
            btn.textContent = 'Create account';
        }
    }

    document.getElementById('loginBtn').onclick = handleLogin;
    document.getElementById('registerBtn').onclick = handleRegister;

    // Allow Enter key to submit auth forms
    document.getElementById('loginPassword').onkeydown = (e) => {
        if (e.key === 'Enter') handleLogin();
    };
    document.getElementById('registerConfirm').onkeydown = (e) => {
        if (e.key === 'Enter') handleRegister();
    };

    // Logout and delete account buttons
    document.getElementById('logoutBtn').onclick = logout;
    document.getElementById('deleteAccountBtn').onclick = deleteAccount;

    // Recursive category expansion with memoization
    function recursiveCategories(subCategories, categories, depth) {
        const allCategories = new Set(categories);
        categories.forEach(e => {
            const cat = e?.toLowerCase?.();
            if (!cat) return;
            const subs = subCategories[cat] ?? [];
            if (!subs.length) return;
            
            let cacheValue = recursiveCache.get(cat);
            if (!cacheValue) {
                recursiveCache.set(cat, -1);
                cacheValue = recursiveCategories(subCategories, subs, depth + 1);
                recursiveCache.set(cat, cacheValue);
            } else if (cacheValue === -1) {
                recursiveCache.set(cat, []);
                cacheValue = recursiveCategories(subCategories, subs, depth + 1);
                recursiveCache.set(cat, cacheValue);
            }
            allCategories.add(...subs);
            allCategories.add(...cacheValue);
        });
        return new Set([...allCategories].map(e => e?.toLowerCase?.() || e));
    }

    // Convert category ID to display name
    function convertCat(cat) {
        if (cat.startsWith("p:")) {
            cat = cat.slice(2);
            return pagesArr.find(e => e.id == cat)?.title ?? noPageMaps[cat] ?? cat;
        }
        return cat;
    }

    // Update the stats sidebar
    // Debounced sidebar update to prevent DOM thrash on rapid clicks
    let engagementUpdateScheduled = false;
    function scheduleEngagementUpdate() {
        if (engagementUpdateScheduled) return;
        engagementUpdateScheduled = true;
        requestAnimationFrame(() => {
            updateEngagement();
            engagementUpdateScheduled = false;
        });
    }

    // Update the stats sidebar with interactive controls
    function updateEngagement() {
        const statsEl = document.querySelector(".stats");
        // Preserve close button for mobile drawer
        const closeBtn = statsEl.querySelector(".stats-close");
        statsEl.innerHTML = "";
        if (closeBtn) statsEl.appendChild(closeBtn);

        const sorted = Object.entries(categoryScores)
            .filter(([k, v]) => v && !hiddenCategories.has(k))
            .sort((a, b) => b[1] - a[1]);
        const top10 = sorted.slice(0, 10);
        const bottom10 = sorted.slice(Math.max(sorted.length - 10, 10));

        function createCatRow(cat, score) {
            const row = document.createElement("div");
            row.classList.add("cat-row");

            const nameSpan = document.createElement("span");
            nameSpan.classList.add("cat-name");
            nameSpan.title = convertCat(cat);
            nameSpan.textContent = convertCat(cat);

            const scoreSpan = document.createElement("span");
            scoreSpan.classList.add("cat-score");
            scoreSpan.textContent = score > 0 ? `+${score}` : String(score);

            const boostBtn = document.createElement("button");
            boostBtn.classList.add("cat-ctrl");
            boostBtn.textContent = "+";
            boostBtn.title = "Boost this category";
            boostBtn.setAttribute("aria-label", `Boost ${convertCat(cat)}`);
            boostBtn.onclick = (e) => {
                e.stopPropagation();
                categoryScores[cat] = (categoryScores[cat] || 0) + 200;
                scheduleEngagementUpdate();
            };

            const buryBtn = document.createElement("button");
            buryBtn.classList.add("cat-ctrl");
            buryBtn.textContent = "\u2212";
            buryBtn.title = "Bury this category";
            buryBtn.setAttribute("aria-label", `Bury ${convertCat(cat)}`);
            buryBtn.onclick = (e) => {
                e.stopPropagation();
                categoryScores[cat] = (categoryScores[cat] || 0) - 200;
                scheduleEngagementUpdate();
            };

            const hideBtn = document.createElement("button");
            hideBtn.classList.add("cat-ctrl");
            hideBtn.textContent = "\u00d7";
            hideBtn.title = "Hide this category";
            hideBtn.setAttribute("aria-label", `Hide ${convertCat(cat)}`);
            hideBtn.onclick = (e) => {
                e.stopPropagation();
                hiddenCategories.add(cat);
                scheduleEngagementUpdate();
            };

            row.appendChild(nameSpan);
            row.appendChild(scoreSpan);
            row.appendChild(boostBtn);
            row.appendChild(buryBtn);
            row.appendChild(hideBtn);
            return row;
        }

        // Top categories
        if (top10.length) {
            const topTitle = document.createElement("div");
            topTitle.classList.add("stats-section-title");
            topTitle.textContent = "Top Categories";
            statsEl.appendChild(topTitle);
            top10.forEach(([k, v]) => statsEl.appendChild(createCatRow(k, v)));
        }

        // Bottom categories
        if (bottom10.length) {
            const bottomTitle = document.createElement("div");
            bottomTitle.classList.add("stats-section-title");
            bottomTitle.textContent = "Bottom Categories";
            bottomTitle.style.marginTop = "12px";
            statsEl.appendChild(bottomTitle);
            bottom10.forEach(([k, v]) => statsEl.appendChild(createCatRow(k, v)));
        }

        // Hidden categories section
        if (hiddenCategories.size > 0) {
            const hiddenSection = document.createElement("div");
            hiddenSection.classList.add("hidden-section");

            const toggleBtn = document.createElement("button");
            toggleBtn.classList.add("hidden-toggle");
            toggleBtn.textContent = `Hidden (${hiddenCategories.size}) \u25B6`;
            toggleBtn.setAttribute("aria-expanded", "false");
            toggleBtn.setAttribute("aria-label", `Show ${hiddenCategories.size} hidden categories`);

            const hiddenList = document.createElement("div");
            hiddenList.classList.add("hidden-list");

            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                const expanded = hiddenList.classList.toggle("expanded");
                toggleBtn.textContent = `Hidden (${hiddenCategories.size}) ${expanded ? "\u25BC" : "\u25B6"}`;
                toggleBtn.setAttribute("aria-expanded", String(expanded));
            };

            hiddenCategories.forEach(cat => {
                const row = document.createElement("div");
                row.classList.add("hidden-row");

                const nameSpan = document.createElement("span");
                nameSpan.classList.add("cat-name");
                nameSpan.textContent = convertCat(cat);

                const unhideBtn = document.createElement("button");
                unhideBtn.classList.add("unhide-btn");
                unhideBtn.textContent = "unhide";
                unhideBtn.setAttribute("aria-label", `Unhide ${convertCat(cat)}`);
                unhideBtn.onclick = (e) => {
                    e.stopPropagation();
                    hiddenCategories.delete(cat);
                    scheduleEngagementUpdate();
                };

                row.appendChild(nameSpan);
                row.appendChild(unhideBtn);
                hiddenList.appendChild(row);
            });

            hiddenSection.appendChild(toggleBtn);
            hiddenSection.appendChild(hiddenList);
            statsEl.appendChild(hiddenSection);
        }
    }

    // Apply engagement score to post categories
    // skipHidden: when true, categories in hiddenCategories are not scored
    function engagePost(post, amount, skipHidden = false) {
        post.allCategories.forEach(e => {
            if (skipHidden && hiddenCategories.has(e)) return;
            categoryScores[e] = (categoryScores[e] ?? 0) + amount;
        });
        savePreferences();
        return amount;
    }

    // Update session stats display
    function updateSessionStats() {
        document.getElementById('viewCount').textContent = articlesViewed;
        document.getElementById('likeCount').textContent = articlesLiked;
    }

    // Show double-tap heart animation
    function showDoubleTapHeart(postDiv) {
        const heart = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        heart.setAttribute("viewBox", "0 0 24 24");
        heart.classList.add("double-tap-heart");
        heart.innerHTML = '<path d="m12.06,21.01c3.94,0,13.77-11.36,8.56-16.37-4.59-4.41-8.61,1.58-8.61,1.58,0,0-4.02-5.99-8.61-1.58-5.22,5.01,4.61,16.37,8.56,16.37h.11Z" stroke-width="2" fill="red" stroke="red"/>';
        postDiv.appendChild(heart);
        heart.addEventListener("animationend", () => heart.remove());
    }

    // Show full-size image in popover
    function showPic(imgName) {
        const fullImg = document.createElement("img");
        fullImg.src = `https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/${imgName.replace(/ /g, '_')}`;
        fullImg.popover = "auto";
        fullImg.classList.add("fullImg");
        document.body.appendChild(fullImg);
        fullImg.showPopover();
        fullImg.ontoggle = (e) => e.newState === "open" || fullImg.remove();
        fullImg.onclick = () => fullImg.hidePopover();
    }

    // Create and render a post element
    function createNextPost(specificPost = null) {
        const nextPost = specificPost || getNextPost();
        const postDiv = document.createElement("article");
        const postTitle = document.createElement("h1");
        const postP = document.createElement("p");
        const postYes = document.createElement("button");
        const shareBtn = document.createElement("button");
        const buttonRow = document.createElement("div");

        postDiv.classList.add("post");
        postDiv.dataset.testid = "post";
        postDiv.dataset.title = nextPost.title;
        postDiv.setAttribute("tabindex", "0");
        postDiv.setAttribute("aria-label", `Article: ${nextPost.title}. Press Enter to open on Wikipedia.`);

        const openWikipedia = () => {
            window.open(`https://simple.wikipedia.org/wiki/${nextPost.title.replace(/ /g, '_')}`);
            if (!postDiv.dataset.engaged) {
                postDiv.dataset.engaged = engagePost(nextPost, 75);
            }
        };

        postDiv.onclick = (e) => {
            const now = Date.now();

            // Fix race condition: clear timer if tapping a different post
            if (singleTapTimer && lastTapTarget !== postDiv) {
                clearTimeout(singleTapTimer);
                singleTapTimer = null;
            }

            const isDoubleTap = (now - lastTapTime < 300) && (lastTapTarget === postDiv);

            if (isDoubleTap) {
                // Double-tap detected - trigger like
                clearTimeout(singleTapTimer);
                singleTapTimer = null;

                // Only animate and like if not already liked
                if (!postYes.dataset.liked) {
                    postYes.click();
                    showDoubleTapHeart(postDiv);
                }

                // Reset tap tracking
                lastTapTime = 0;
                lastTapTarget = null;
            } else {
                // First tap - wait to see if it's a double-tap
                lastTapTime = now;
                lastTapTarget = postDiv;

                // Delay single-tap action to check for second tap
                singleTapTimer = setTimeout(() => {
                    if (lastTapTarget === postDiv) {
                        openWikipedia();
                    }
                    lastTapTime = 0;
                    lastTapTarget = null;
                }, 300);
            }
        };

        postDiv.onkeydown = (e) => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                openWikipedia();
            }
        };

        postTitle.innerText = nextPost.title;
        postP.innerText = nextPost.text;
        postYes.innerText = "Like";
        postYes.dataset.testid = "like-button";
        postYes.setAttribute("aria-label", `Like this article: ${nextPost.title}`);
        postYes.setAttribute("aria-pressed", "false");

        const handleLike = (e) => {
            postYes.dataset.liked = "true";
            postYes.setAttribute("aria-pressed", "true");
            if (!postYes.dataset.engaged) {
                postYes.dataset.engaged = engagePost(nextPost, 50 + postsWithoutLike * 4);
                // Update session stats for likes
                articlesLiked++;
                currentStreak++;
                if (currentStreak > maxStreak) {
                    maxStreak = currentStreak;
                }
                updateSessionStats();
            }
            postsWithoutLike = 0;
            setTimeout(updateEngagement, 100);
            e.stopPropagation();
        };

        postYes.onclick = handleLike;

        shareBtn.innerText = "Share";
        shareBtn.classList.add("share-btn");
        shareBtn.dataset.testid = "share-button";
        shareBtn.setAttribute("aria-label", `Share this article: ${nextPost.title}`);

        shareBtn.onclick = (e) => {
            e.stopPropagation();
            const shareUrl = `${window.location.origin}${window.location.pathname}?article=${nextPost.id}`;
            navigator.clipboard.writeText(shareUrl)
                .then(() => {
                    shareBtn.classList.add("copied");
                    shareBtn.setAttribute("aria-label", "Link copied!");
                    setTimeout(() => {
                        shareBtn.classList.remove("copied");
                        shareBtn.setAttribute("aria-label", `Share this article: ${nextPost.title}`);
                    }, 2000);
                })
                .catch(() => {
                    // Fallback: show the URL in a prompt
                    prompt('Copy this link:', shareUrl);
                });
        };

        buttonRow.classList.add("button-row");

        postDiv.appendChild(postTitle);

        // Display recommendation reason if available
        if (nextPost.recommendedBecause && nextPost.recommendedBecause.length > 0) {
            const reasonP = document.createElement("p");
            reasonP.classList.add("recommendation-reason");
            reasonP.innerText = "Because you liked: " + nextPost.recommendedBecause.join(", ");
            postDiv.appendChild(reasonP);
        }

        postDiv.appendChild(postP);
        
        if (nextPost.thumb) {
            const postImg = document.createElement("img");
            postImg.src = `https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/${nextPost.thumb.replace(/ /g, '_')}&width=512`;
            postImg.classList.add("media");
            postImg.loading = "eager";
            postImg.onerror = () => postImg.remove();
            postImg.onclick = (e) => {
                showPic(nextPost.thumb);
                if (!postImg.dataset.engaged) {
                    postImg.dataset.engaged = engagePost(nextPost, 100);
                }
                e.stopPropagation();
            };
            postDiv.appendChild(postImg);
        }

        // More like this / Less like this feedback buttons
        const moreBtn = document.createElement("button");
        moreBtn.innerText = "More like this";
        moreBtn.classList.add("more-btn", "feedback-btn");
        moreBtn.setAttribute("aria-label", `More like this: ${nextPost.title}`);
        moreBtn.onclick = (e) => {
            e.stopPropagation();
            if (moreBtn.disabled) return;
            moreBtn.disabled = true;
            engagePost(nextPost, 150, true); // skipHidden=true for "More like this"
            updateEngagement();
            const gotIt = document.createElement("span");
            gotIt.classList.add("got-it");
            gotIt.textContent = "Got it";
            moreBtn.appendChild(gotIt);
            gotIt.addEventListener("animationend", () => gotIt.remove());
        };

        const lessBtn = document.createElement("button");
        lessBtn.innerText = "Less like this";
        lessBtn.classList.add("less-btn", "feedback-btn");
        lessBtn.setAttribute("aria-label", `Less like this: ${nextPost.title}`);
        lessBtn.onclick = (e) => {
            e.stopPropagation();
            if (lessBtn.disabled) return;
            lessBtn.disabled = true;
            engagePost(nextPost, -150);
            updateEngagement();
            const gotIt = document.createElement("span");
            gotIt.classList.add("got-it");
            gotIt.textContent = "Got it";
            lessBtn.appendChild(gotIt);
            gotIt.addEventListener("animationend", () => gotIt.remove());
        };

        buttonRow.appendChild(moreBtn);
        buttonRow.appendChild(lessBtn);
        // Spacer pushes share/like to the right
        const spacer = document.createElement("div");
        spacer.classList.add("button-spacer");
        buttonRow.appendChild(spacer);
        buttonRow.appendChild(shareBtn);
        buttonRow.appendChild(postYes);
        postDiv.appendChild(buttonRow);
        engagePost(nextPost, -5);
        postsWithoutLike++;
        document.querySelector(".posts").appendChild(postDiv);

        // Update session stats
        articlesViewed++;
        updateSessionStats();
    }

    // Get next post using the scoring algorithm
    function getNextPost() {
        const potentialPosts = [...Array(10000)]
            .map(() => pagesArr[Math.floor(Math.random() * pagesArr.length)])
            .map(post => {
                const initialScore = (post.thumb ? 5 : 0) + (3 ** (post.seen ?? 0) - 1) * -50000;
                const postScore = [...post.allCategories].reduce(
                    (sum, cat) => sum + (categoryScores[cat] ?? 0),
                    initialScore
                );
                post.score = postScore;
                return post;
            });

        let highestScore = -Infinity;
        let bestPost = potentialPosts[0];

        if (Math.random() < 0.4) {
            // Weighted random selection
            const minScore = Math.min(...potentialPosts.map(e => e.score));
            const maxScore = potentialPosts.reduce((sum, post) => sum + post.score - minScore, 0);
            const targetScore = Math.random() * maxScore;
            let scoreCount = 0;

            while (scoreCount < targetScore && potentialPosts.length) {
                const potentialPost = potentialPosts.pop();
                bestPost = potentialPost;
                scoreCount += potentialPost.score - minScore;
            }
        } else if (Math.random() > 0.3) {
            // Highest score selection
            potentialPosts.forEach(post => {
                if (post.score > highestScore) {
                    bestPost = post;
                    highestScore = post.score;
                }
            });
        }

        bestPost.seen = (bestPost.seen ?? 0) + 1;

        // Track top contributing categories for transparency
        const categoryContributions = [...bestPost.allCategories]
            .map(cat => ({ cat, score: categoryScores[cat] || 0 }))
            .filter(c => c.score > 0)  // Only positive contributions
            .sort((a, b) => b.score - a.score)
            .slice(0, 3);

        if (categoryContributions.length > 0) {
            bestPost.recommendedBecause = categoryContributions.map(c => convertCat(c.cat));
        } else {
            bestPost.recommendedBecause = null;
        }

        return bestPost;
    }

    // Render loop - creates posts as user scrolls
    function render() {
        if (document.documentElement.scrollHeight < scrollY + innerHeight + 1500) {
            createNextPost();
        }
        requestAnimationFrame(render);
    }

    // Add a category picker button
    function addPickableCategory(cat, checked) {
        const escapedCat = cat.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
        if (document.querySelector(`.categoryPicker input[data-category="${escapedCat}"]`)) {
            return;
        }
        const picker = document.createElement("label");
        const check = document.createElement("input");
        const labelText = `${cat.slice(0, 1).toUpperCase()}${cat.slice(1).toLowerCase()}`;
        check.type = "checkbox";
        picker.innerText = labelText;
        picker.appendChild(check);
        picker.classList.add("categoryPicker");
        check.dataset.category = cat;
        if (checked) check.checked = true;
        categoryPickList.appendChild(picker);
    }

    // Stream reader helper
    async function* streamToAsyncIterable(stream) {
        const reader = stream.getReader();
        try {
            while (true) {
                const { done, value } = await reader.read();
                if (done) return;
                yield value;
            }
        } finally {
            reader.releaseLock();
        }
    }

    // Format bytes to human readable
    function formatBytes(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Format seconds to human readable time
    function formatTime(seconds) {
        if (seconds < 60) return Math.ceil(seconds) + 's';
        const mins = Math.floor(seconds / 60);
        const secs = Math.ceil(seconds % 60);
        return `${mins}m ${secs}s`;
    }

    // Fetch file with progress tracking and retry logic
    async function getFileWithProgress(url, retryCount = 0) {
        const MAX_RETRIES = 3;
        const loadingProgress = document.getElementById('loadingProgress');
        const loadingProgressBar = document.getElementById('loadingProgressBar');
        const loadingDetails = document.getElementById('loadingDetails');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const retryBtn = document.getElementById('retryBtn');

        loadingProgress.style.display = 'block';
        errorMessage.classList.remove('visible');

        try {
            const resp = await fetch(url, { cache: "force-cache" });

            if (!resp.ok) {
                throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
            }

            let responseSize = 0;
            const bytes = new Uint8Array(DATA_SIZE);
            const startTime = Date.now();
            let speedSamples = [];
            let lastSampleTime = startTime;
            let lastSampleSize = 0;

            for await (const chunk of streamToAsyncIterable(resp.body)) {
                bytes.set(chunk, responseSize);
                responseSize += chunk.length;

                const now = Date.now();
                const percent = Math.floor(responseSize / DATA_SIZE * 100);

                // Calculate speed every 500ms
                if (now - lastSampleTime >= 500) {
                    const bytesInInterval = responseSize - lastSampleSize;
                    const secondsInInterval = (now - lastSampleTime) / 1000;
                    const currentSpeed = bytesInInterval / secondsInInterval;

                    speedSamples.push(currentSpeed);
                    if (speedSamples.length > 5) speedSamples.shift();

                    lastSampleTime = now;
                    lastSampleSize = responseSize;
                }

                // Update UI
                loadingProgressBar.style.width = percent + '%';
                startBtn.innerText = `Downloading... ${percent}%`;

                if (speedSamples.length > 0) {
                    const avgSpeed = speedSamples.reduce((a, b) => a + b, 0) / speedSamples.length;
                    const remaining = DATA_SIZE - responseSize;
                    const eta = remaining / avgSpeed;
                    loadingDetails.innerText = `${formatBytes(responseSize)} of ${formatBytes(DATA_SIZE)} ¬∑ ${formatBytes(avgSpeed)}/s ¬∑ ~${formatTime(eta)} remaining`;
                } else {
                    loadingDetails.innerText = `${formatBytes(responseSize)} of ${formatBytes(DATA_SIZE)}`;
                }
            }

            loadingProgressBar.style.width = '100%';
            startBtn.innerText = `Download complete, processing...`;
            loadingDetails.innerText = '';
            await new Promise(requestAnimationFrame);
            await new Promise(requestAnimationFrame);
            return JSON.parse(new TextDecoder().decode(bytes.subarray(0, responseSize)));

        } catch (error) {
            console.error('Download failed:', error);

            if (retryCount < MAX_RETRIES) {
                const delay = Math.pow(2, retryCount) * 1000; // Exponential backoff
                startBtn.innerText = `Connection lost, retrying in ${delay/1000}s...`;
                loadingDetails.innerText = `Attempt ${retryCount + 2} of ${MAX_RETRIES + 1}`;
                await new Promise(r => setTimeout(r, delay));
                return getFileWithProgress(url, retryCount + 1);
            }

            // All retries failed
            loadingProgress.style.display = 'none';
            loadingDetails.innerText = '';
            errorMessage.classList.add('visible');
            errorText.innerText = error.message || 'Network error. Please check your connection.';
            startBtn.innerText = 'Loading failed';

            // Return a promise that resolves when user clicks retry
            return new Promise((resolve) => {
                retryBtn.onclick = () => {
                    resolve(getFileWithProgress(url, 0));
                };
            });
        }
    }

    // ============================================
    // Feature 2: Feed Refresh
    // ============================================

    function refreshFeed() {
        // Clear all posts from DOM
        const postsContainer = document.querySelector(".posts");
        postsContainer.innerHTML = "";
        // Reset seen counters and stale recommendation reasons
        pagesArr.forEach(p => { delete p.seen; delete p.recommendedBecause; });
        // Reset like streak counter
        postsWithoutLike = 0;
        // Scroll to top
        window.scrollTo(0, 0);
        // The render loop is already running via rAF, new posts auto-generate
    }

    // Pull-to-refresh state
    let pullStartY = 0;
    let pullDist = 0;
    let isPulling = false;
    const PULL_THRESHOLD = 80;

    function initPullToRefresh() {
        const postsContainer = document.querySelector(".posts");

        // Create pull indicator element
        const indicator = document.createElement("div");
        indicator.classList.add("pull-to-refresh-indicator");
        indicator.id = "pullIndicator";
        indicator.innerHTML = '<span class="spinner">‚Üª</span> Pull to refresh';
        postsContainer.parentNode.insertBefore(indicator, postsContainer);

        // Common handlers for both touch and pointer events
        function handlePullStart(clientY) {
            if (window.scrollY <= 0) {
                pullStartY = clientY;
                isPulling = true;
            }
        }

        function handlePullMove(clientY, preventDefault) {
            if (!isPulling) return;
            pullDist = clientY - pullStartY;
            if (pullDist < 0) pullDist = 0;
            if (pullDist > 0 && window.scrollY <= 0) {
                if (preventDefault) preventDefault();
                indicator.classList.add("active");
                const progress = Math.min(pullDist / PULL_THRESHOLD, 1);
                indicator.style.height = (progress * 48) + "px";
                indicator.style.opacity = progress;
                if (pullDist >= PULL_THRESHOLD) {
                    indicator.innerHTML = '<span class="spinner">‚Üª</span> Release to refresh';
                } else {
                    indicator.innerHTML = '<span>‚Üì</span> Pull to refresh';
                }
            }
        }

        function handlePullEnd() {
            if (isPulling && pullDist >= PULL_THRESHOLD) {
                indicator.innerHTML = '<span class="spinner">‚Üª</span> Refreshing...';
                setTimeout(() => {
                    refreshFeed();
                    indicator.classList.remove("active");
                    indicator.style.height = "0";
                    indicator.style.opacity = "0";
                }, 300);
            } else {
                indicator.classList.remove("active");
                indicator.style.height = "0";
                indicator.style.opacity = "0";
            }
            isPulling = false;
            pullDist = 0;
        }

        // Touch events (mobile)
        postsContainer.addEventListener("touchstart", (e) => {
            handlePullStart(e.touches[0].clientY);
        }, { passive: true });

        postsContainer.addEventListener("touchmove", (e) => {
            handlePullMove(e.touches[0].clientY, () => e.preventDefault());
        }, { passive: false });

        postsContainer.addEventListener("touchend", handlePullEnd, { passive: true });

        // Pointer events (desktop mouse + touch)
        let isPointerPulling = false;
        postsContainer.addEventListener("pointerdown", (e) => {
            if (e.pointerType === 'touch') return; // Handled by touch events
            isPointerPulling = true;
            handlePullStart(e.clientY);
            postsContainer.setPointerCapture(e.pointerId);
        });

        postsContainer.addEventListener("pointermove", (e) => {
            if (e.pointerType === 'touch' || !isPointerPulling) return;
            handlePullMove(e.clientY, () => e.preventDefault());
        });

        postsContainer.addEventListener("pointerup", (e) => {
            if (e.pointerType === 'touch') return;
            if (isPointerPulling) {
                handlePullEnd();
                isPointerPulling = false;
                postsContainer.releasePointerCapture(e.pointerId);
            }
        });

        postsContainer.addEventListener("pointercancel", (e) => {
            if (isPointerPulling) {
                indicator.classList.remove("active");
                indicator.style.height = "0";
                indicator.style.opacity = "0";
                isPulling = false;
                pullDist = 0;
                isPointerPulling = false;
            }
        });
    }

    // ============================================
    // Feature 4: Mobile Sidebar Drawer
    // ============================================
    function initMobileDrawer() {
        const statsEl = document.querySelector(".stats");
        const backdrop = document.getElementById("statsBackdrop");
        const toggleBtn = document.getElementById("statsToggleBtn");
        const closeBtn = statsEl.querySelector(".stats-close");

        function openDrawer() {
            statsEl.classList.add("open");
            backdrop.classList.add("visible");
        }

        function closeDrawer() {
            statsEl.classList.remove("open");
            backdrop.classList.remove("visible");
        }

        toggleBtn.onclick = (e) => {
            e.stopPropagation();
            openDrawer();
        };

        backdrop.onclick = () => closeDrawer();

        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && statsEl.classList.contains("open")) {
                closeDrawer();
            }
        });

        if (closeBtn) {
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                closeDrawer();
            };
        }

        // Swipe-to-dismiss on the drawer
        let drawerTouchStartX = 0;
        let drawerTouchCurrentX = 0;
        let isDragging = false;

        statsEl.addEventListener("touchstart", (e) => {
            drawerTouchStartX = e.touches[0].clientX;
            drawerTouchCurrentX = e.touches[0].clientX;
            isDragging = true;
        }, { passive: true });

        statsEl.addEventListener("touchmove", (e) => {
            if (!isDragging) return;
            drawerTouchCurrentX = e.touches[0].clientX;
            const dx = drawerTouchCurrentX - drawerTouchStartX;
            if (dx > 20) {
                statsEl.style.transform = `translateX(${dx}px)`;
            }
        }, { passive: true });

        statsEl.addEventListener("touchend", () => {
            if (!isDragging) return;
            const dx = drawerTouchCurrentX - drawerTouchStartX;
            statsEl.style.transform = "";
            if (dx > 80) {
                closeDrawer();
            }
            isDragging = false;
            drawerTouchCurrentX = 0;
        }, { passive: true });
    }

    // Start the feed (extracted so both auth and guest paths can use it)
    function startFeed(sharedArticle) {
        startScreen.hidePopover();
        startScreen.remove();

        // Initialize mobile sidebar drawer
        initMobileDrawer();

        // Show floating refresh button and init pull-to-refresh
        document.getElementById("refreshBtn").style.display = "flex";
        document.getElementById("refreshBtn").onclick = (e) => {
            e.stopPropagation();
            refreshFeed();
        };
        initPullToRefresh();

        // Show logout/delete buttons if logged in
        if (isLoggedIn()) {
            document.getElementById('logoutBtn').style.display = 'block';
            document.getElementById('deleteAccountBtn').style.display = 'block';
        }
        // If there's a shared article, show it first
        if (sharedArticle) {
            sharedArticle.seen = (sharedArticle.seen ?? 0) + 1;
            createNextPost(sharedArticle);
        }
        requestAnimationFrame(render);
    }

    // Main initialization
    async function main() {
        startScreen.showPopover();

        // Configure auth section based on login state
        const authSection = document.getElementById('authSection');
        const categoryPickerSection = document.getElementById('categoryPickerSection');

        if (isLoggedIn()) {
            // Show welcome message instead of auth form
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'auth-welcome';
            welcomeDiv.appendChild(document.createTextNode('Welcome back, '));
            const strong = document.createElement('strong');
            strong.style.margin = '0 4px';
            strong.textContent = currentUser();
            welcomeDiv.appendChild(strong);
            welcomeDiv.appendChild(document.createTextNode('! '));
            const logoutLink = document.createElement('a');
            logoutLink.textContent = 'Log out';
            logoutLink.onclick = logout;
            logoutLink.style.cursor = 'pointer';
            welcomeDiv.appendChild(logoutLink);
            authSection.innerHTML = '';
            authSection.appendChild(welcomeDiv);
            // Hide category picker for logged-in users
            categoryPickerSection.style.display = 'none';
        }

        defaultCategories.forEach(e => addPickableCategory(e));
        startBtn.innerText = "Xikipedia is loading... (downloading ~40MB of data)";

        const smoldata = await getFileWithProgress("smoldata.json");

        const subCategories = smoldata.subCategories;
        noPageMaps = smoldata.noPageMaps;
        delete smoldata.subCategories;
        delete smoldata.noPageMaps;

        let i = 0;
        const wikiLen = smoldata.pages.length;
        console.log(`Processing ${wikiLen} articles...`);
        const loading = document.querySelector("#loading");
        let lastFrame = Date.now();

        const loadingDetails = document.getElementById('loadingDetails');
        const loadingProgressBar = document.getElementById('loadingProgressBar');

        let filteredCount = 0;

        while (smoldata.pages.length) {
            const e = smoldata.pages.pop();

            // Skip articles with very short text (less than 100 chars)
            if (e[2] && e[2].length < 100) {
                filteredCount++;
                i++;
                continue;
            }

            const tempPage = {
                title: e[0],
                id: e[1],
                text: e[2],
                thumb: e[3],
                categories: e[4],
                links: e[5]
            };

            if (i % 1000 === 0 && Date.now() - lastFrame > 20) {
                const percent = (i / wikiLen * 100).toFixed(0);
                startBtn.innerText = `Processing articles... ${percent}%`;
                loadingProgressBar.style.width = percent + '%';
                loadingDetails.innerText = `${i.toLocaleString()} of ${wikiLen.toLocaleString()} articles`;
                await new Promise(r => requestAnimationFrame(r));
                lastFrame = Date.now();
            }
            i++;

            tempPage.allCategories = new Set(recursiveCategories(subCategories, [...tempPage.categories], 0));
            tempPage.allCategories.add(`p:${tempPage.id}`);
            tempPage.allCategories.add(...tempPage.links.map(e => `p:${e}`));
            pagesArr.push(tempPage);
        }

        console.log(`Filtered ${filteredCount} short articles (less than 100 characters)`);

        loading.remove();
        document.getElementById('loadingProgress').style.display = 'none';
        document.getElementById('loadingDetails').innerText = `${wikiLen.toLocaleString()} articles ready`;
        startBtn.removeAttribute("disabled");
        categorySearchInput.removeAttribute("disabled");
        startBtn.innerText = "I'm an adult, continue";

        // Check for shared article URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const sharedArticleId = urlParams.get('article');
        let sharedArticle = null;
        if (sharedArticleId) {
            sharedArticle = pagesArr.find(p => p.id == sharedArticleId);
            if (!sharedArticle) {
                // Article not found - log warning
                console.warn('Shared article not found:', sharedArticleId);
            }
            // Clear the URL parameter
            window.history.replaceState({}, '', window.location.pathname);
        }

        // If logged in, load saved preferences and auto-start
        if (isLoggedIn()) {
            try {
                const prefsResp = await fetch('/api/preferences', {
                    headers: getAuthHeaders()
                });
                if (!prefsResp.ok) throw new Error('Failed to load preferences');
                const prefs = await prefsResp.json();

                // Apply saved categoryScores (merge, preserving defaults like given names: -1000)
                if (prefs.categoryScores) {
                    Object.entries(prefs.categoryScores).forEach(([k, v]) => {
                        categoryScores[k] = v;
                    });
                }

                // Apply saved hiddenCategories if present
                if (prefs.hiddenCategories && Array.isArray(prefs.hiddenCategories)) {
                    prefs.hiddenCategories.forEach(cat => hiddenCategories.add(cat));
                }

                // Auto-start the feed
                startFeed(sharedArticle);
                return;
            } catch (e) {
                console.warn('Failed to load preferences, clearing auth:', e);
                localStorage.removeItem('xiki_token');
                localStorage.removeItem('xiki_username');
                // Fall through to normal start screen - reload to show guest UI
                window.location.reload();
                return;
            }
        }

        startBtn.onclick = () => {
            document.querySelectorAll(".categoryPicker>input:checked").forEach(e => {
                categoryScores[e.dataset.category] = defaultCategories.includes(e.dataset.category) ? 1000 : 5000;
            });
            document.querySelectorAll(".categoryPicker>input:checked").forEach(e => {
                if (defaultCategories.includes(e.dataset.category)) return;
                const page = pagesArr.find(x => x.title.toLowerCase() === e.dataset.category);
                if (page) engagePost(page, 100);
            });
            startFeed(sharedArticle);
        };
    }

    // Expose state for testing
    window.categoryScores = categoryScores;
    window.hiddenCategories = hiddenCategories;
    window.pagesArr = pagesArr;
    // Expose postsWithoutLike as a getter for testing
    Object.defineProperty(window, 'postsWithoutLike', { get: () => postsWithoutLike });

    window.onload = main;
</script>
</body>
</html>
